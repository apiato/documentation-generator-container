<?php

namespace App\Containers\Vendor\Documentation\Actions;

use App\Containers\Vendor\Documentation\Tasks\GenerateAPIDocsTask;
use App\Containers\Vendor\Documentation\Tasks\GetAllDocsTypesTask;
use App\Containers\Vendor\Documentation\Tasks\RenderApidocJsonTask;
use App\Containers\Vendor\Documentation\Tasks\RenderTemplatesTask;
use App\Containers\Vendor\Documentation\Traits\DocsGeneratorTrait;
use App\Containers\Vendor\Documentation\UI\CLI\Commands\GenerateApiDocsCommand;
use App\Ship\Parents\Actions\Action;

class GenerateDocumentationAction extends Action
{
    use DocsGeneratorTrait;

    public function run(GenerateApiDocsCommand $console): void
    {
        // get docs types that needs to be generated by the user base on his configs.
        $types = app(GetAllDocsTypesTask::class)->run();

        $this->removeOldConfigs();

        foreach ($types as $type) {
            app(RenderApidocJsonTask::class, ['docType' => $type])->run();
        }

        // parse the markdown file.
        app(RenderTemplatesTask::class)->run();

        $console->info("Generating API Documentations for (" . implode(' & ', $types) . ")\n");

        // for each type, generate docs.
        $documentationUrls = array_map(static function ($type) use ($console) {
            return app(GenerateAPIDocsTask::class)->run($type, $console);
        }, $types);

        $console->info("Done! You can access your API Docs at: \n" . implode("\n", $documentationUrls));
    }

    private function removeOldConfigs(): void
    {
        $files = glob($this->getApiDocJsConfigsPath() . '/*');
        foreach ($files as $file) {
            if (is_file($file)) {
                unlink($file);
            }
        }
    }
}
